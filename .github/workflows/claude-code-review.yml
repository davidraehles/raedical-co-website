name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

          # Check if diff is too large (Claude has token limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            echo "Diff is too large for review (${DIFF_SIZE} bytes)"
            echo "large_diff=true" >> $GITHUB_OUTPUT
          else
            echo "large_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Claude
        if: steps.diff.outputs.large_diff == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff
          DIFF_CONTENT=$(cat pr_diff.txt)

          # Prepare the prompt for Claude
          cat > review_prompt.json <<'EOF'
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": "You are a code reviewer. Please review the following pull request diff and provide:\n\n1. A summary of the changes\n2. Potential issues or bugs\n3. Security concerns (if any)\n4. Code quality suggestions\n5. Best practices recommendations\n\nBe constructive and specific. Format your response in markdown.\n\n```diff\n${DIFF_CONTENT}\n```"
              }
            ]
          }
          EOF

          # Replace the placeholder with actual diff content
          jq --arg diff "$DIFF_CONTENT" '.messages[0].content = "You are a code reviewer. Please review the following pull request diff and provide:\n\n1. A summary of the changes\n2. Potential issues or bugs\n3. Security concerns (if any)\n4. Code quality suggestions\n5. Best practices recommendations\n\nBe constructive and specific. Format your response in markdown.\n\n```diff\n" + $diff + "\n```"' review_prompt.json > request.json

          # Call Claude API
          REVIEW=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @request.json | jq -r '.content[0].text')

          # Save review to file
          echo "$REVIEW" > claude_review.txt

      - name: Post review comment
        if: steps.diff.outputs.large_diff == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create comment file with review
          cat > pr_comment.md <<'COMMENT_EOF'
## ðŸ¤– Claude Code Review

COMMENT_EOF
          cat claude_review.txt >> pr_comment.md
          cat >> pr_comment.md <<'COMMENT_EOF'

---
*This review was automatically generated by Claude Sonnet 4.5*
COMMENT_EOF

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} --body-file pr_comment.md

      - name: Post size warning
        if: steps.diff.outputs.large_diff == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## âš ï¸ Claude Code Review

The diff for this PR is too large for automated review. Please consider breaking this into smaller PRs for better review quality.

---
*This message was automatically generated by the Claude Code Review workflow*"
